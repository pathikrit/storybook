<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8">
    <title>Story Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link id="picocss" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.1.1/css/pico.classless.min.css">
    <style>
        audio {
            width: 100%;
            margin: 20px 0;
        }
    </style>
</head>
<body>
<main>
    <h1 id="header">Create story</h1>
    <form id="form"></form>
    <div id="result"></div>
</main>
<script>
    const inputs = [
        {name: "who", label: "Who:", defaultValue: "3-yr old boy named Aidan", type: "text"},
        {name: "prompt", label: "Prompt:", defaultValue: "Colorful bison and a monster truck", type: "text"},
        {name: "bedtime", label: "Bedtime mode (calm voice)", defaultValue: false, type: "checkbox"},
        {name: "include_child", label: "Include child in story", defaultValue: true, type: "checkbox"},
        {name: "generate_audio", label: "Read story aloud", defaultValue: true, type: "checkbox"},
        {name: "generate_images", label: "Add images to story", defaultValue: true, type: "checkbox"}
    ]

    const createInputs = () => {
        const form = $('#form')
        inputs.forEach((input) => {
            const value = localStorage.getItem(input.name) ?? input.defaultValue
            const labelElmt = $(`<label for="${input.name}">${input.label}</label>`)
            const inputElmt = $(`<input type="${input.type}" id="${input.name}" name="${input.name}">`)
            switch (input.type) {
                case "text":
                    form.append(labelElmt.prop("required", true))
                    form.append(inputElmt.val(value))
                    break
                case "checkbox":
                    form.append(inputElmt.prop("checked", value === true || value === "true"))
                    form.append(labelElmt.prop("role", "switch"))
                    break
            }
        })
        form.append(`<button type="submit" id="make_story_button">Make Story</button>`)
    }

    const readInputs = () => {
        const params = {}
        inputs.forEach((input) => {
            const el = $(`#${input.name}`)
            const value = input.type === "checkbox" ? el.is(":checked") : el.val()
            localStorage.setItem(input.name, value)
            params[input.name] = value
        })
        return params
    }

    const download = (fileName) => {
        const clone = $("html").clone()
        for (const selector of ["#header", "#form", "#download"]) {
            clone.find(selector).remove()
        }
        const blob = new Blob([clone[0].outerHTML], {type: "text/html"})
        const url = URL.createObjectURL(blob)
        const link = $("<a>")
            .attr("href", url)
            .attr("download", fileName)
            .appendTo("body")
        link[0].click()
        link.remove()
        URL.revokeObjectURL(url)
    }

    const submit = (event) => {
        event.preventDefault()
        const output = $('#result')
        output.html('<span aria-busy="true">Writing story...</span>')
        $.get('/story', readInputs(), (res) => {
            output.html(`<article>${res.story}</article>`)
            if (res.audio_uri) output.prepend(`<audio controls autoplay src="${res.audio_uri}"></audio>`)
            output.prepend(`<button id="download" onclick="download('${res.file_name}')">Download Story</button>`)
        })
    }

    $(document).ready(() => {
        createInputs()
        $('#bedtime').on('change', () => {
            const theme = $("#bedtime").is(":checked") ? "violet" : "pumpkin";
            $("#picocss").attr("href", `https://cdn.jsdelivr.net/npm/@picocss/pico@2.1.1/css/pico.classless.${theme}.min.css`);
        })
        $('#form').on('submit', submit)
    })
</script>
</body>
</html>
